---
import { ViewTransitions } from 'astro:transitions';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import GoogleAnalytics from '../components/GoogleAnalytics.astro';
import { useTranslations } from '../utils/translate';
import '../css/global.css';
const t = useTranslations(Astro);
const { lang } = Astro.params || { lang: 'en' };
const canonicalBase = 'https://juanelojga.com';
const localePath = lang === 'en' ? '' : `/${lang}`;
const canonicalUrl = `${canonicalBase}${localePath}/`;

const personSchema = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: 'Juan Almeida',
  jobTitle: t('seo.jobTitle'),
  description: t('seo.description'),
  url: canonicalUrl,
  sameAs: ['https://www.linkedin.com/in/juan-almeida-03806367', 'https://github.com/juanelojga'],
};
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <GoogleAnalytics />
    <meta name="description" content={t('seo.description')} />
    <meta property="og:title" content={t('seo.title')} />
    <meta property="og:description" content={t('seo.description')} />
    <meta name="twitter:title" content={t('seo.title')} />
    <meta name="twitter:description" content={t('seo.description')} />
    <meta name="viewport" content="width=device-width" />
    <meta
      name="keywords"
      content="Juan Almeida, Full Stack Engineer, AI Engineer, Software Developer, JavaScript, Python, React, Astro, Django"
    />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" href="https://juanelojga.com/" hreflang="en" />
    <link rel="alternate" href="https://juanelojga.com/es/" hreflang="es" />
    <link rel="alternate" href="https://juanelojga.com/" hreflang="x-default" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={t('seo.title')} />
    <meta name="twitter:description" content={t('seo.description')} />
    <meta name="twitter:image" content="https://juanelojga.com/og-image.jpg" />
    <script type="application/ld+json" set:html={JSON.stringify(personSchema)} />

    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <meta name="generator" content={Astro.generator} />
    <title>{t('seo.title')}</title>
    <meta property="og:title" content={t('seo.title')} />
    <meta property="og:description" content={t('seo.description')} />
    <meta property="og:image" content="/og-image.jpg" />
    <ViewTransitions />
  </head>
  <body class="bg-black text-white">
    <a href="#main" class="sr-only focus:not-sr-only">Skip to content</a>
    <Navbar />
    <main id="main"><slot /></main>
    <Footer />

    <script is:inline>
      function initDesktopNav() {
        const sections = document.querySelectorAll('section[id], header[id]');
        const navLinks = document.querySelectorAll("nav a[href^='#']");
        const footer = document.querySelector('footer');
        let scrollTimeout;
        let contactActive = false;
        let lastY = window.scrollY;
        let scrollDirection = 'down';

        // Ensure Hero section visible by default
        if (sections.length > 0) {
          sections[0].classList.add('active-section');
          navLinks[0]?.classList.add('text-green-400');
        }

        // Helper: is last section (Contact) in viewport?
        function isContactActive() {
          const lastSection = sections[sections.length - 1];
          if (!lastSection) return false;
          const rect = lastSection.getBoundingClientRect();
          // At least 30% visible
          const threshold = Math.max(0.3 * rect.height, 1);
          return rect.top < window.innerHeight - threshold && rect.bottom > threshold;
        }

        // Intersection observer setup
        const observer = new IntersectionObserver(
          entries => {
            if (window.innerWidth < 1024) return;
            entries.forEach(entry => {
              const target = entry.target;
              if (entry.isIntersecting) {
                target.classList.add('active-section');
                navLinks.forEach(link => {
                  const isActive = link.getAttribute('href').replace('#', '') === target.id;
                  link.classList.toggle('text-green-400', isActive);
                });
                history.replaceState(null, '', `#${target.id}`);
                if (target === sections[sections.length - 1]) {
                  contactActive = true;
                  if (footer) {
                    footer.style.visibility = 'visible';
                    footer.style.opacity = '1';
                  }
                }
              } else {
                const rect = entry.boundingClientRect;
                if (rect.bottom < 0 || rect.top > window.innerHeight) {
                  target.classList.remove('active-section');
                }
                if (target === sections[sections.length - 1]) {
                  contactActive = false;
                  if (footer) {
                    footer.style.visibility = '';
                    footer.style.opacity = '';
                  }
                }
              }
            });
          },
          { threshold: 0.3, rootMargin: '-20% 0px -20% 0px' }
        );

        sections.forEach(section => observer.observe(section));

        // Smooth scroll for navbar links
        navLinks.forEach(link => {
          link.addEventListener('click', e => {
            if (window.innerWidth < 1024) return;
            e.preventDefault();
            const targetId = link.getAttribute('href');
            const target = document.querySelector(targetId);
            if (target) target.scrollIntoView({ behavior: 'smooth' });
          });
        });

        const handleScroll = () => {
          if (window.innerWidth < 1024) return;
          const currentY = window.scrollY;
          scrollDirection = currentY > lastY ? 'down' : 'up';
          lastY = currentY;

          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(() => {
            if (isContactActive()) {
              if (footer) {
                footer.style.visibility = 'visible';
                footer.style.opacity = '1';
              }
              return;
            }
            const snapThreshold = 100;
            if (scrollDirection === 'up' && currentY < window.innerHeight - snapThreshold) return;

            let closest = null;
            let closestDistance = Infinity;
            const viewportCenter = window.innerHeight / 2;

            sections.forEach(section => {
              const rect = section.getBoundingClientRect();
              const sectionCenter = rect.top + rect.height / 2;
              const distance = Math.abs(sectionCenter - viewportCenter);
              if (distance < closestDistance) {
                closest = section;
                closestDistance = distance;
              }
            });

            if (closest) closest.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 150);
        };

        window.addEventListener('scroll', handleScroll);
        window.observer = observer;
        window.handleScroll = handleScroll;
      }

      function cleanupDesktopNav() {
        if (window.observer) {
          window.observer.disconnect();
          window.observer = null;
        }
        if (window.handleScroll) {
          window.removeEventListener('scroll', window.handleScroll);
          window.handleScroll = null;
        }
        window.navInitialized = false;
      }

      if (window.innerWidth >= 1024) {
        initDesktopNav();
        window.navInitialized = true;
      }

      window.addEventListener('resize', () => {
        const isDesktop = window.innerWidth >= 1024;
        if (isDesktop && !window.navInitialized) {
          initDesktopNav();
        } else if (!isDesktop && window.navInitialized) {
          cleanupDesktopNav();
        }
      });
    </script>
  </body>
</html>
